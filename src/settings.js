
var fs = require('fs');
var saveFileURL = 'scheduledscan.json';

function loadScanStatus() {
	var saved = loadScheduleFromFile();/*
	var label = document.getElementById('status-label');
	if( saved == null )
		label.innerHTML = 'No scan scheduled';
	else
		label.innerHTML = saved['status'];
		*/
}

function loadScheduleFromFile() {
	fs.readFile(saveFileURL, function(err, data) {
		if( err ) {
			document.getElementById('status-label').innerHTML = 'No scan scheduled';
			console.log('error threw: ' + err);
		}
		else {
			var obj = JSON.parse(data.toString('utf-8'));
			document.getElementById('status-label').innerHTML = obj['status'];
			scheduleScan(Date(obj['date']), obj['interval']); //load saved scans
		}
	});
}


function toggleRecurrent() {
	document.getElementById('single').classList.toggle('hidden');
	document.getElementById('recurrent').classList.toggle('hidden');
}

function handleSchedule() {
	var type = getScheduleType();
	var newStatus;
	if( type == 'recurrent' )
		//newDate = handleScheduleRecurrent();
		newStatus = handleScheduleRecurrent();
	else
		//newDate = handleScheduleSingle();
		newStatus = handleScheduleSingle();

	console.log('setting new status');
	document.getElementById('status-label').innerHTML = newStatus;
}

function isValidDate(dateObj) {
	return ! isNaN(dateObj.getDate());
}

function isValidInterval(n) {
	return typeof n == 'number';
	return typeof n == 'number' && !isNaN(n) && isFinite(n) && n > 0;
}

function getScheduleType() {
	if( document.getElementById('recurrent').classList.contains('hidden') )
		return 'single';
	else
		return 'recurrent';
}

function formatDate(date) {
	return ("" + date).substring(0, 25);
}

function handleScheduleRecurrent() {
	var dateStart = getDateSingle();
	var interval = getRecurrentDays();

	if( ! isValidDate(dateStart) )
		return "Invalid start date";
	if( ! isValidInterval(interval) )
		return "Invalid interval";

	var dateString = formatDate(dateStart);
	var mystatus = "Recurrent scan scheduled starting at " + dateString + ' and running every ' + interval + ' days.';

	saveSchedule(mystatus, dateStart, interval);
	return mystatus;
}

function handleScheduleSingle() {
	var date = getDateSingle();
	var dateString = formatDate(date);
	if( ! isValidDate(date) )
		return "Invalid date";
	var mystatus = "Scan scheduled for " + dateString;
	saveSchedule(mystatus, date, -1);
	return mystatus;
}

function saveSchedule(scanStatus, date, interval) {
	scheduleScan(date, interval);			//schedule scan
	var myobj = {	"status": scanStatus,
					"date": date.toJSON(),
					"interval": interval
	};
	var data_str = JSON.stringify(myobj);
	fs.writeFile(saveFileURL, data_str, function(err) {
		if( err )
			console.log('unable to save date ' + data_str + '; error occurred: '+err);
		else
			console.log('saved scheduled scan to file successfully');
	});
}

function getRecurrentDays() {
	var interval = document.getElementById('recurrent-interval').value;
	console.log('got interval '+interval);
	return Number(interval);
}

function getDateSingle() {
	var date = picker.getDate();
	var hour = Number(document.getElementById('single-hour').value);
	if( hour == 12 )
		hour -= 12;
	if( document.getElementById('single-hour-type').value == 'pm' )
		hour += 12;
	date.setHours(hour);
	return date;
}
