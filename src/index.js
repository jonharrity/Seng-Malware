const {
  spawn
} = require("child_process");
const os = require("os");
var schedule = require('node-schedule');

var scan = null; // current running scan. null if no scan is currently running
var type = ""
const date = new Date();
var logName = "./LOGS/" + date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + "-" + date.getHours() + date.getMinutes() + "scanlog.txt";

function toggleSettings() {
  var a = document.getElementById('container');
  var b = document.getElementById('container-settings');
  a.classList.toggle('hidden');
  b.classList.toggle('hidden');
}

function changeTab(evt, cityName) {
  var i, tabcontent, tablinks;
  tabcontent = document.getElementsByClassName("tabcontent");

  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }

  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }

  document.getElementById(cityName).style.display = "block";
  evt.currentTarget.className += " active";
}

function DeepScanSelected() {
  type = "deep";

  let currCard = document.getElementById("DeepSelect");
  currCard.classList.add("selected")

  let oldCard = document.getElementById("ShallowSelect")
  oldCard.classList.remove("selected")

  console.log("deep scan has been selected")
}

function ShallowScanSelected() {
  type = "shallow";

  let currCard = document.getElementById("ShallowSelect");
  currCard.classList.add("selected")

  let oldCard = document.getElementById("DeepSelect")
  oldCard.classList.remove("selected")

  console.log("shallow scan has been selected")
}

function Scan(stype) {
  // code to power the optional arg to make choosing scans easier in the background
  var out = document.getElementById("scanoutput");
  var btn = document.getElementById("Scan")
  stype = stype || "";
  if (stype !== "shallow" || "deep" || "") {
    stype = "";
  }
  else if (stype === "shallow" || "deep") {
    type = stype;
  }

  if (scan == null) {

    console.log(`type: ${type}`);
    if (type === "deep") {
      scan = spawn("clamscan", ["-r", "C:", "--move=QUARANTINE", "--exclude=\QUARANTINE", `-l${logName}`]);
      out.innerHTML = "Deep scan starting...<br>(this might take a moment)<br>";
    } else if (type === "shallow") {
      scan = spawn("clamscan", ["-r", "--file-list=scanlist.txt", "--move=QUARANTINE", "--exclude=\QUARANTINE", `-l${logName}`]);
      out.innerHTML = "Shallow scan starting...<br>(this might take a moment)<br>";
    }
    else if (type == "") {
      btn.onclick = () => {
        alert('Please select a scan!')
      }
    }
  }

  console.log(scan);

  if (scan) {
    ShowTextarea();
  }

  scan.stdout.on("data", chunk => {
    let output = chunk.toString();
    if (output.includes("OK")) {
      out.innerHTML += `<span class="OK"> ${output}</span><br>`
    } else if (output.includes("FOUND")) {
      out.innerHTML += `<span class="FOUND"> ${output}</span><br>`
    } else {
      out.innerHTML += output;
    }

    out.scrollTop = out.scrollHeight;
  });

  scan.on("close", code => {
    out.value += `Done<br>`;

    console.log(`finished with code: ${code}`);
    scan = null;

    let open = document.getElementById("select-area").classList.contains("closed")
    if (open) {
      btn.innerHTML = "Close"
    } else {
      btn.innerHTML = "Scan"
    }
  })
}

function ShowTextarea() {
  let selectArea = document.getElementById('select-area');
  selectArea.classList.add('closed');

  let button = document.getElementById('Scan');
  button.innerHTML = "Cancel"
  button.onclick = End;

  let scanoutput = document.getElementById('scanoutput');
  scanoutput.classList.remove('hidden');
}

function End() {
  console.log(scan);
  let open = document.getElementById('select-area').classList.contains("closed")
  var out = document.getElementById("scanoutput");

  if (scan != null) {
    scan.kill()
    console.log("scan has stopped");
    out.innerHTML = "Scan has stopped";
    scan = null

  }
  if (open) {

    let area = document.getElementById("select-area")
    area.classList.remove("closed")

    let button = document.getElementById('Scan');
    button.innerHTML = "Scan";
    button.onclick = Scan;

    let scanoutput = document.getElementById('scanoutput');
    scanoutput.classList.add('hidden');

  }
}

function loading() {
  const updateClam = spawn('freshclam')

  let btn = document.getElementById("Scan")

  btn.innerHTML = "Updating..."
  btn.onclick = () => {
    alert('Updating malware signatures')
  }

  updateClam.stdout.on('data', chunk => {
    console.log(`clamAV is updating\n ${chunk.toString()}\n`)

  })

  updateClam.on('close', chunk => {
    console.log('clamAV has been updated')
    btn.onclick = Scan
    btn.innerHTML = "Scan"
  })


}


//Schedules a scan
function scheduleScan(scanDate, interval) {
  var scheduleDate = new Date(scanDate);
  console.log(scheduleDate);  //this produces incorrect date on startup
  if (interval > 0) {
    var rule = new schedule.RecurrenceRule();
    rule.date = interval;
    var scheduledScan = schedule.scheduleJob(scheduleDate, rule, function () {
      Scan("shallow");
    });
  }
  else if (interval == -1) {
    var scheduledScan = schedule.scheduleJob(scheduleDate, function () {
      Scan("shallow");
    });
  }
  console.log(type + " Scan is scheduled for " + scheduleDate); //this produces incorrect date on startup
}

//Test scheduler, will run every 5 minutes
function testScan(date, recurrence, recurrenceValue) {
  var scheduledScan = schedule.scheduleJob('5 * * * *', Scan("shallow"));
  console.log(type + " Scan is scheduled for " + date);
}
