const {
  spawn
} = require("child_process");
const os = require("os");

function openNav() {
  document.getElementById("sidenav").style.width = "200px";
}

function closeNav() {
  document.getElementById("sidenav").style.width = "0";
}

function changeTab(evt, tabname) {
  console.log(`open ${tabname}`);
  var i, tabcontent;
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  document.getElementById(tabname).style.display = "block";
  closeNav();
}

var currentlyScanning = false;

function deepScan() {
  const out = document.getElementById("deepscanout");

  if (!currentlyScanning) {
    var deepscan = spawn("clamscan", ["-r", "/"]);
    out.innerHTML = "Starting scan...<br>(this might take a moment)<br>";
    currentlyScanning = true;
  } else {
    out.innerHTML += "A scan has already started<br>";
  }

  deepscan.stdout.on("data", chuck => {
    let output = chuck.toString();
    if (output.includes("OK")) {
      out.innerHTML += `<span class="OK"> ${output}</span><br>`
    } else if (output.includes("FOUND")) {
      out.innerHTML += `<span class="FOUND"> ${output}</span><br>`
    } else {
      out.innerHTML += output;
    }

    out.scrollTop = out.scrollHeight;
  });

  deepscan.on("close", code => {
    const out = document.getElementById("deepscanout");
    out.value += `Done<br>`;
    currentlyScanning = false;
  })
}

function shallowScan() {
  const out = document.getElementById("shallowscanout");

  if (!currentlyScanning) {
    var shallowscan = spawn("clamscan", ["-r", "/", "-f", "filelist.txt"]);
    out.innerHTML += "Starting scan...<br>(this might take a moment)<br>";
    currentlyScanning = true
  } else {
    out.innerHTML += "A scan has already started<br>";
  }

  shallowscan.stdout.on("data", chuck => {
    let output = chuck.toString();
    if (output.includes("OK")) {
      out.innerHTML += `<span class="OK">${chuck.toString()}</span><br>`;
    } else if (output.includes("FOUND")) {
      out.innerHTML += `<span class="FOUND">${chuck.toString()}</span><br>`;
    } else {
      out.innerHTML += output;
    }

    out.scrollTop = out.scrollHeight;
  });

  shallowscan.on("close", code => {
    const out = document.getElementById("shallowscanout");
    out.innerHTML += `Done<br>`;
    currentlyScanning = false;
  })
}