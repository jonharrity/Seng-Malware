const {
  spawn
} = require("child_process");
const os = require("os");
const {app} = require("electron");
const {shell} = require("electron");
const path = require('path');
const process = require('process');
var schedule = require('node-schedule');

var scan = null; // current running scan. null if no scan is currently running
var out = document.getElementById("scanoutput");
var type = ""

function DeepScanSelected() {
  type = "deep";

  let currCard = document.getElementById("DeepSelect");
  currCard.classList.add("selected")

  let oldCard = document.getElementById("ShallowSelect")
  oldCard.classList.remove("selected")

  console.log("deep scan has been selected")

}

function deepScan() {
  console.log(`clamscan ${os.homedir()}`);  //Users default directory
  console.log(`${path.normalize(__dirname)}`);    //Seng-Malware\src
  console.log(`Starting directory: ${process.cwd()}`);
  const date = new Date();
  console.log(date);
  var logName = "/LOGS/" + date.getFullYear() + "-" + (date.getMonth()+1)+ "-" + date.getDate() + "scanlog.txt";
  console.log(logName);

  const deepscan = spawn("clamscan", ["-r", "C:", "--move=QUARANTINE", "--exclude=\QUARANTINE", `-l${logName}`]);
  const out = document.getElementById("deepscanout");
  out.value += "Starting scan...\n";

  deepscan.stdout.on("data", chuck => {
    out.value += `${chuck.toString()}\n`;
    out.scrollTop = out.scrollHeight;
  });

  let currCard = document.getElementById("ShallowSelect");
  currCard.classList.add("selected")

  let oldCard = document.getElementById("DeepSelect")
  oldCard.classList.remove("selected")

  //Log file moved into the LOGS folder
  var logFile = path.basename(logName);
  var dest = path.resolve(/LOGS/, logFile);

  fs.rename(logFile, dest, (err) =>{
    if(err) throw err;
    else console.log('Log Generated Successfully');
  });
}

function shallowScan() {
  console.log(`clamscan ${os.homedir()}`);
  const date = new Date();
  console.log(date);
  var logName = "./LOGS/" + date.getFullYear() + "-" + (date.getMonth()+1)+ "-" + date.getDate() + "scanlog.txt";
  console.log(logName);

  const shallowscan = spawn("clamscan", ["-r", "--file-list=scanlist.txt", "--move=QUARANTINE", "--exclude=\Quarantine", `-l${logName}`]);
  const out = document.getElementById("shallowscanout");


  shallowscan.stdout.on("data", chuck => {
    out.value += `${chuck.toString()}\n`;
    out.scrollTop = out.scrollHeight;
  });

  scan.on("close", code => {
    out.value += `Done<br>`;
    console.log(`finished with code: ${code}`);
    scan = null;
  })

}


function end() {
  console.log(scan);
  if (scan != null) {
    scan.kill()
    console.log("scan has stopped")
    out.innerHTML = "Scan has stopped";
    scan = null
  } else {
    console.log("no scan has started")
    out.innerHTML = "no scan has started"
  }
}
