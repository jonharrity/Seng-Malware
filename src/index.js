const {
  spawn
} = require("child_process");
const os = require("os");

var scan = null; // current running scan. null if no scan is currently running
var out = document.getElementById("scanoutput");
var type = ""
let btn = document.getElementById("Scan")

function DeepScanSelected() {
  type = "deep";

  let currCard = document.getElementById("DeepSelect");
  currCard.classList.add("selected")

  let oldCard = document.getElementById("ShallowSelect")
  oldCard.classList.remove("selected")

  console.log("deep scan has been selected")

}

function ShallowScanSelected() {
  type = "shallow";

  let currCard = document.getElementById("ShallowSelect");
  currCard.classList.add("selected")

  let oldCard = document.getElementById("DeepSelect")
  oldCard.classList.remove("selected")

  console.log("shallow scan has been selected")
}

function Scan() {
  const date = new Date();
  var logName ="./LOGS/"+ date.getFullYear() + "-" + (date.getMonth()+1) + "-" + date.getDate() + "-" + date.getHours() + date.getMinutes() + "scanlog.txt";
  console.log(logName);
  console.log(`${process.cwd()}`);

  if (scan == null) {

    console.log(type)
    if (type === "deep") {
      scan = spawn("clamscan", ["-r", "C:", "--move=QUARANTINE", "--exclude=\QUARANTINE", `-l${logName}`]);
      out.innerHTML = "Deep scan starting...<br>(this might take a moment)<br>";
    } else if (type === "shallow") {
      scan = spawn("clamscan", ["-r", "--file-list=scanlist.txt", "--move=QUARANTINE", "--exclude=\QUARANTINE", `-l${logName}`]);
      out.innerHTML = "Shallow scan starting...<br>(this might take a moment)<br>";
    } else if (type == "") {
      btn.onclick = () => { alert("You haven't chosen a scan type!") }
    }

  } else {
    out.innerHTML += "A scan has already started<br>";
  }

  console.log(scan)

  scan.stdout.on("data", chunk => {
    let output = chunk.toString();
    if (output.includes("OK")) {
      out.innerHTML += `<span class="OK"> ${output}</span><br>`
    } else if (output.includes("FOUND")) {
      out.innerHTML += `<span class="FOUND"> ${output}</span><br>`
    } else {
      out.innerHTML += output;
    }

    out.scrollTop = out.scrollHeight;
  });

  scan.on("close", code => {
    out.value += `Done<br>`;
    console.log(`finished with code: ${code}`);
    scan = null;
  })
}

function loading()
{
	const updateClam = spawn("freshclam")
	btn.innerHTML = "Updating..."
	btn.onclick = () => { alert("Updating malware signatures, please wait!") }

	updateClam.stdout.on("data", chunk => { console.log("ClamAV is updating\n ${chunk.toString()}\n") })
	updateClam.stdout.on("close", chunk =>
	{
		console.log("ClamAV has been updated")
		btn.onclick = Scan
		btn.innerHTML = "Scan"
	})
}

function end() {
  console.log(scan);
  if (scan != null) {
    scan.kill()
    console.log("scan has stopped")
    out.innerHTML = "Scan has stopped";
    scan = null
  } else {
    console.log("no scan has started")
    out.innerHTML = "no scan has started"
  }
}
